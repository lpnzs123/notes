# Mysql是怎样运行的：第十九章笔记

---

## ACID

---

对数据库的每一个操作都相当于对操作对应的，现实世界中的对象的一次**状态转换**（例如数据库的一次转账操作使得对应用户账户的一次状态转换）。我们想让对数据库的操作符合现实世界中状态转换的规则，就必须先知道状态转换的规则有哪些。标题已经给出了答案，ACID，下面我们来介绍一下**数据库的四大特性（ACID）**。

<br />

### 原子性（Atomicity）

---

原子意味着不可分割。

一个操作可以被分解成若干个步骤，在执行这个操作后，有三种情况：

* 步骤全成功。
* 步骤中有些成功有些失败。
* 步骤全失败。

现在假设这个操作是一次转账，明显的，这个操作有两个基本的步骤（账户 A 转钱给账户 B）：

1. 把钱从账户 A 中取出来。
2. 把从账户 A 中取出来的钱转给账户 B。

问题来了，当步骤 1 完成后系统宕机，导致了步骤 2 没有进行，这时候怎么办呢？

这种情况应该是不允许发生的，我们希望两个步骤先后发生，要么全做，要么全不做，这才是一次转账操作，或者说，这就是**原子性**。也就是说，我们希望转账操作是原子的，是不可分割的，我们不希望转账操作还可以被分成两个步骤分别进行，存在可能一个成功一个失败的**中间态**。

如何处理一个不可分割的操作执行后产生的中间态？当然是将已经执行的操作撤销，将状态恢复到执行不可分割的操作之前的样子。

<br />

### 隔离性（Isolation）

---

仍以一次转账操作为例（账户 A 转钱给账户 B），列出操作的基本步骤如下（步骤做了二次细分，列出了更详细的步骤）：

1. 把钱从账户 A 中取出来。
   1. 从磁盘中读取账户 A 的金额。
   2. 账户 A 的金额减去转账的金额，为账户 A 的余额。
   3. 存储账户 A 的余额进磁盘里。
2. 把从账户 A 中取出来的钱转给账户 B。
   1. 从磁盘中读取账户 B 的金额。
   2. 账户 B 的金额加上转账的金额，为账户 B 的余额。
   3. 存储账户 B 的余额进磁盘里。

这里我们认为转账操作是原子的，不可分割。也就是说，上述步骤要么全做，要么全不做。现在我们**同时**执行两次转账金额相同的转账操作，两次都是账户 A 转钱给账户 B。

假设两次转账操作分别为 T1 和 T2，**理想情况下**，有两种执行方式：

* 先执行 T1 后执行 T2
* 先执行 T2 后执行 T1

以先执行 T1 后执行 T2 为例，两次转账步骤如下：

1. 先执行 T1。
   1. 从磁盘中读取账户 A 的金额。
   2. 账户 A 的金额减去转账的金额，为账户 A 的余额。
   3. 存储账户 A 的余额进磁盘里。
   4. 从磁盘中读取账户 B 的金额。
   5. 账户 B 的金额加上转账的金额，为账户 B 的余额。
   6. 存储账户 B 的余额进磁盘里。
2. 后执行 T2。
   1. 从磁盘中读取账户 A 的金额。
   2. 账户 A 的金额减去转账的金额，为账户 A 的余额。
   3. 存储账户 A 的余额进磁盘里。
   4. 从磁盘中读取账户 B 的金额。
   5. 账户 B 的金额加上转账的金额，为账户 B 的余额。
   6. 存储账户 B 的余额进磁盘里。

没毛病不是吗？但这是对现实世界中对象的两次**状态转换**，明显的，这两次状态转换是相互**隔离**的。

对于数据库来说，两次转账的步骤可能是这样的（假设两次转账的金额都是 5 元，账户 A 的初始金额为 10 元，账户 B 的初始金额为 10 元，两次转账结束后，账户 A 的余额应该是 0 元，账户 B 的余额应该是 20 元）：

1. 从磁盘中读取账户 A 的金额。（T1）
2. 从磁盘中读取账户 A 的金额。（T2）
3. 账户 A 的金额减去转账的金额，为账户 A 的余额。（T1）
4. 存储账户 A 的余额进磁盘里。（T1）
5. 从磁盘中读取账户 B 的金额。（T1）
6. 账户 B 的金额加上转账的金额，为账户 B 的余额。（T1）
7. 存储账户 B 的余额进磁盘里。（T1）
8. 账户 A 的金额减去转账的金额，为账户 A 的余额。（T2）
9. 存储账户 A 的余额进磁盘里。（T2）
10. 从磁盘中读取账户 B 的金额。（T2）
11. 账户 B 的金额加上转账的金额，为账户 B 的余额。（T2）
12. 存储账户 B 的余额进磁盘里。（T2）

最终，账户 A 的余额为 5 元，账户 B 的月为 20 元，这和我们的设想相去甚远。

**注意：这并没有违反原子性。因为原子性只要我们保证 T1 或 T2 的操作步骤，要么全成功，要么全失败就行了，并没有说 T1、T2 的步骤不可互相干扰。**

错误的结果使得我们不得不开始思考，仅仅保证转账操作的原子性，就行了吗？我们应该还要保证两次转账操作的隔离性！也就是 T1、T2 的步骤是不可以相互干扰的！

所以对现实世界中状态转换对应的某些数据库操作来说，不仅要保证这些操作以原子性的方式执行完成，而且要保证其它的状态转换不会影响到本次的状态转换，这个规则被称之为**隔离性**。





































